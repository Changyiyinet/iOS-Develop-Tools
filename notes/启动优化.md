
## App启动优化
https://time.geekbang.org/column/article/85331
https://juejin.im/post/5cff0ada6fb9a07edc0b4c3c?utm_source=gold_browser_extension
https://juejin.im/post/5db654fc5188257d606aaf2a?utm_source=gold_browser_extension
https://techblog.toutiao.com/2017/01/17/iosspeed/#more
https://mp.weixin.qq.com/s/jN3jaNrvXczZoYIRCWZs7w

http://yulingtianxia.com/blog/2016/10/30/Optimizing-App-Startup-Time/

二进制重排：  

http://yulingtianxia.com/blog/2019/09/01/App-Order-Files/

https://mp.weixin.qq.com/s/YDO0ALPQWujuLvuRWdX7dQ

https://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ==&mid=2247485101&idx=1&sn=abbbb6da1aba37a04047fc210363bcc9&scene=21#wechat_redirect

https://juejin.im/post/5e1280fae51d41540e47ca450

https://mp.weixin.qq.com/s?__biz=MzAxNDEwNjk5OQ==&mid=2650405083&idx=1&sn=f52e8dcf03faafcf910d58add9904550&scene=21#wechat_redirect

##  App的启动耗时

### 介绍

App 的启动时间是体现其性能优劣的一个重要指标，启动时间越快用户的等待时间就越短，提升用户体验感，大厂应用甚至会做到“ 毫秒必究 ”。  

我们将 App 启动方式分为：

| 名称   | 说明                                                         |
| ------ | ------------------------------------------------------------ |
| 冷启动 | App 启动时，应用进程不在系统中（初次打开或程序被杀死），需要系统分配新的进程来启动应用。 |
| 热启动 | App 退回后台后，对应的进程还在系统中，启动则将应用返回前台展示。 |

本篇文章主要针对冷启动方式进行优化分析，介绍常用的检测工具及优化方法。

### 冷启动流程

Apple 官方的[《WWDC Optimizing App Startup Time》](https://developer.apple.com/videos/play/wwdc2016/406) 将 iOS 应用的启动可分为 pre-main 阶段和 main 两个阶段，最佳的启动速度是400ms以内，最慢不得大于20s，否则会被系统进程杀死（最低配置设备）。

按照正常用户使用体验，笔者认为还应包括首屏页面展示后才算是完成了整个启动流程，因此我们将 **App总启动流程 = pre-main + 执行main函数 + 首屏渲染（viewDidAppear）**。

#### pre-main 执行内容

- 加载可执行文件

  加载 `Mach-O` 格式文件，既 App 中所有类编译后生成的格式为 `.o` 的目标文件集合。

- 加载动态库

  `dyld` 加载 `dylib` 会完成如下步骤：

  1. 分析 App 依赖的所有 dylib。
  2. 找到 dylib 对应的 Mach-O 文件。
  3. 打开、读取这些 Mach-O 文件，并验证其有效性。
  4. 在系统内核中注册代码签名。
  5. 对 dylib 的每一个 segment 调用 mmap()。

  系统依赖的动态库由于被优化过，可以较快的加载完成，而开发者引入的动态库需要耗时较久。

- Rebase和Bind操作

  由于使用了`ASLR` 技术，在 `dylib` 加载过程中，需要计算指针偏移得到正确的资源地址。 `Rebase` 将镜像读入内存，修正镜像内部的指针，消耗 `IO` 性能；`Bind` 查询符号表，进行外部镜像的绑定，需要大量 `CPU` 计算。

- Objc setup

  进行 `Objc` 的初始化，包括注册 `Objc` 类、检测 ` selector` 唯一性、插入分类方法等。

- Initializers

  往应用的堆栈中写入内容，包括执行 `+load` 方法、调用 `C/C++` 中的构造器函数（用 `attribute((constructor))` 修饰的函数）、创建非基本类型的 `C++` 静态全局变量等。

#### main函数执行内容

从 `main()` 函数开始执行到 `didFinishLaunchingWithOptions` 方法执行结束的耗时。通常会在这个过程中进行各种工具（监控工具、推送、定位等）初始化、权限申请、判断版本、全局配置等。

#### 首屏渲染执行内容

完成首屏 `UI` 的构建，需要 `CPU` 计算布局并由 `GPU` 完成渲染。

## 优化方案

### pre-main阶段

#### 检测方法

获得 main() 方法执行前的耗时比较简单，通过 Xcode 自带的测量方法既可以。将 Xcode 中 Edit scheme -> Run -> Environment Variables 将环境变量 `DYLD_PRINT_STATISTICS` 或 `DYLD_PRINT_STATISTICS_DETAILS`  设为 `1` 即可获得每项内容的耗时：

```
// DYLD_PRINT_STATISTICS

// DYLD_PRINT_STATISTICS_DETAILS

```



 ####  优化手段

### 执行main函数阶段

#### 检测方法

#### 优化手段

### 首屏渲染阶段

#### 检测方法

#### 优化手段

避免在主线程进行大量的计算，将与首屏无关的计算内容放在页面展示后进行，缩短 `CPU` 计算时间。避免使用大图片，减少视图数量及层级，减轻 `GPU ` 的负担。

### 全方面方案

启动优化不应该是一次性的，最好的方案不是在出现才去解决，而应该包括：

- 解决现存的问题
- 后续开发的管控
- 完整的监控体系



## 工具

- System Trace

- Time Profiler

  https://mp.weixin.qq.com/s/wTF3JSFH5b2zIUYAbnC-Bw

  
  
  

## 参考资料

- [如何实现 iOS App 的冷启动优化](https://mp.weixin.qq.com/s/CIkpPlTrpMEV9lRTwcABrA)  
- [iOS启动优化]([http://lingyuncxb.com/2018/01/30/iOS%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/](http://lingyuncxb.com/2018/01/30/iOS启动优化/))
- [App 启动速度怎么做优化与监控？](https://time.geekbang.org/column/article/85331)